<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>KTX Mini â€“ Quáº£n lÃ½ cho sinh viÃªn</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f6f7fb;
      --panel: #ffffff;
      --panel2: #ffffffcc;
      --text: #0f172a;
      --muted:#64748b;
      --line:#e8ebf2;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --shadow2: 0 6px 18px rgba(15,23,42,.08);
      --brand:#4f46e5;
      --brand2:#22c55e;
      --pink:#ec4899;
      --warn:#f59e0b;
      --danger:#ef4444;
      --ok:#22c55e;
      --chip:#f1f5f9;
      --chipText:#0f172a;
      --radius: 18px;
    }
    [data-theme="dark"]{
      --bg: #0b1220;
      --panel: #0f172a;
      --panel2: rgba(15,23,42,.72);
      --text: #eaf0ff;
      --muted:#a9b6d2;
      --line: rgba(255,255,255,.08);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --shadow2: 0 8px 24px rgba(0,0,0,.25);
      --chip: rgba(255,255,255,.06);
      --chipText: #eaf0ff;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 450px at 15% 0%, rgba(79,70,229,.16), transparent 55%),
        radial-gradient(900px 450px at 85% 15%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg));
      color:var(--text);
      min-height:100vh;
    }

    header{
      position:sticky; top:0; z-index:50;
      background: var(--panel2);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .header-inner{
      max-width:1100px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .logo{
      width:42px; height:42px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(79,70,229,.95), rgba(34,197,94,.85));
      box-shadow: var(--shadow2);
      display:grid; place-items:center;
      color:white; font-weight:900;
    }
    .brand h1{margin:0; font-size:16px; line-height:1.1}
    .brand small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    .top-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--chip);
      color:var(--chipText);
      font-size:12px;
      white-space:nowrap;
    }
    .chip b{font-weight:800}
    .btn{
      border:1px solid var(--line);
      background: var(--panel);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      box-shadow: none;
      transition:.15s;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: var(--shadow2)}
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, var(--brand), rgba(79,70,229,.7));
      color:white;
    }
    .btn.ghost{background: transparent}
    .btn.danger{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
      color: var(--danger);
    }
    .btn.small{padding:7px 10px; border-radius:12px; font-size:12px; font-weight:800}

    .container{
      max-width:1100px;
      margin:18px auto;
      padding:0 16px 90px;
    }

    /* Tabs */
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin:14px 0 16px;
    }
    .tab{
      border:1px solid var(--line);
      background: var(--panel);
      color:var(--muted);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      user-select:none;
      font-weight:800;
      transition:.15s;
    }
    .tab:hover{transform: translateY(-1px)}
    .tab.active{
      color:white;
      border:none;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
    }

    .section{display:none}
    .section.active{display:block}

    /* Cards */
    .grid{display:grid; grid-template-columns:1fr; gap:14px;}
    @media (min-width: 980px){
      .grid.two{grid-template-columns:1fr 1fr;}
      .grid.three{grid-template-columns:1fr 1fr 1fr;}
    }
    .card{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .card h2{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.2px;
    }
    .muted{color:var(--muted); font-size:12px}

    /* Forms */
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:end;
    }
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    input, select, textarea{
      width:280px; max-width:100%;
      padding:10px 11px;
      border-radius:14px;
      border:1px solid var(--line);
      background: transparent;
      color:var(--text);
      outline:none;
      font-weight:600;
    }
    textarea{width:520px; min-height:92px; resize:vertical}
    input::placeholder, textarea::placeholder{color: rgba(100,116,139,.7)}

    /* Tables */
    .table-wrap{overflow:auto; border-radius: 16px; border:1px solid var(--line)}
    table{width:100%; border-collapse:separate; border-spacing:0; min-width: 760px;}
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      background: rgba(79,70,229,.06);
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      position: sticky;
      top: 0;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:hover td{background: rgba(34,197,94,.06)}
    tbody tr:last-child td{border-bottom:none}

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--chip);
      font-size:12px;
      font-weight:800;
    }
    .badge.ok{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); color: var(--ok)}
    .badge.warn{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); color: var(--warn)}
    .badge.pink{border-color: rgba(236,72,153,.35); background: rgba(236,72,153,.10); color: var(--pink)}

    /* Toast */
    .toast{
      position:fixed; right:16px; bottom:16px; z-index:999;
      min-width:260px; max-width:360px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: var(--panel);
      box-shadow: var(--shadow);
      display:none;
    }
    .toast.show{display:block}
    .toast .t{font-weight:900; margin-bottom:4px}
    .toast .m{color:var(--muted); font-size:13px}
    .toast.good{border-color: rgba(34,197,94,.35)}
    .toast.bad{border-color: rgba(239,68,68,.35)}
    .toast.warn{border-color: rgba(245,158,11,.35)}

    /* Mobile bottom bar */
    @media (max-width: 820px){
      .tabs{
        position: fixed;
        left: 10px; right: 10px; bottom: 10px;
        margin:0;
        padding:10px;
        background: var(--panel2);
        border:1px solid var(--line);
        border-radius: 18px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        justify-content: space-between;
      }
      .tab{flex:1; text-align:center; padding:10px 8px; font-size:12px}
      .container{padding-bottom: 140px;}
    }
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo">KTX</div>
      <div>
        <h1>KTX Mini â€“ Quáº£n lÃ½ cho sinh viÃªn</h1>
        <small>PhÃ²ng â€¢ Sinh viÃªn â€¢ HÃ³a Ä‘Æ¡n â€¢ Trá»±c nháº­t â€¢ Báº£ng tin</small>
      </div>
    </div>

    <div class="top-actions">
      <div class="chip">ğŸ”Œ Káº¿t ná»‘i: <b id="connText">...</b></div>
      <button class="btn ghost" onclick="toggleTheme()">ğŸŒ“</button>
      <button class="btn primary" onclick="reloadAll()">ğŸ”„ Táº£i láº¡i</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="tabs">
    <div class="tab active" data-tab="dashboard">ğŸ  Tá»•ng quan</div>
    <div class="tab" data-tab="rooms">ğŸ˜ï¸ PhÃ²ng & SV</div>
    <div class="tab" data-tab="bills">ğŸ§¾ HÃ³a Ä‘Æ¡n</div>
    <div class="tab" data-tab="duty">ğŸ§¹ Trá»±c nháº­t</div>
    <div class="tab" data-tab="board">ğŸ“£ Báº£ng tin</div>
  </div>

  <!-- DASHBOARD -->
  <div class="section active" id="dashboard">
    <div class="grid two">
      <div class="card">
        <h2>ğŸ“Š Tá»•ng quan nhanh</h2>
        <div class="muted">NhÃ¬n biáº¿t KTX Ä‘ang cÃ³ bao nhiÃªu phÃ²ng/sinh viÃªn.</div>
        <div style="height:10px"></div>
        <div class="row">
          <div class="chip">ğŸ  PhÃ²ng: <b id="kRooms">0</b></div>
          <div class="chip">ğŸ“ Sinh viÃªn: <b id="kStudents">0</b></div>
          <div class="chip">ğŸ§¾ HÃ³a Ä‘Æ¡n: <b id="kBills">0</b></div>
          <div class="chip">ğŸ§¹ Lá»‹ch trá»±c: <b id="kDuty">0</b></div>
          <div class="chip">ğŸ“£ Báº£ng tin: <b id="kNotices">0</b></div>
        </div>
        <div style="height:10px"></div>
        <div class="badge warn" id="todayDutyBadge" style="display:none">ğŸ”” HÃ´m nay cÃ³ lá»‹ch trá»±c nháº­t</div>
      </div>

          </div>
  </div>

  <!-- ROOMS -->
  <div class="section" id="rooms">
    <div class="grid two">
      <div class="card">
        <h2>ğŸ˜ï¸ Táº¡o phÃ²ng má»›i</h2>
        <div class="row">
          <label>TÃªn phÃ²ng
            <input id="roomName" placeholder="VD: P101"/>
          </label>
          <label>Sá»‘ ngÆ°á»i tá»‘i Ä‘a
            <input id="maxPeople" type="number" placeholder="VD: 6"/>
          </label>
          <button class="btn primary" onclick="addRoom()">â• ThÃªm phÃ²ng</button>
        </div>
              </div>

      <div class="card">
        <h2>ğŸ“ ThÃªm sinh viÃªn</h2>
        <div class="row">
          <label>Há» tÃªn
            <input id="studentName" placeholder="VD: Nguyá»…n VÄƒn A"/>
          </label>
          <label>Chá»n phÃ²ng
            <select id="roomSelect"></select>
          </label>
          <button class="btn primary" onclick="addStudent()">â• ThÃªm sinh viÃªn</button>
        </div>
        <div class="muted">CÃ³ nÃºt xÃ³a SV Ä‘á»ƒ â€œquáº£n lÃ½ tháº­tâ€, khÃ´ng chá»‰ nháº­p.</div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <h2>ğŸ“‹ Danh sÃ¡ch phÃ²ng</h2>
        <div class="muted">XÃ³a phÃ²ng sáº½ bá»‹ cháº·n náº¿u cÃ²n sinh viÃªn/hÃ³a Ä‘Æ¡n/lá»‹ch trá»±c liÃªn quan.</div>
        <div style="height:12px"></div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>PhÃ²ng</th>
                <th>Tá»‘i Ä‘a</th>
                <th>Sá»‘ SV</th>
                <th>HÃ nh Ä‘á»™ng</th>
              </tr>
            </thead>
            <tbody id="roomList"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ‘¥ Danh sÃ¡ch sinh viÃªn</h2>
        <div style="height:12px"></div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Há» tÃªn</th>
                <th>PhÃ²ng</th>
                <th>HÃ nh Ä‘á»™ng</th>
              </tr>
            </thead>
            <tbody id="studentList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- BILLS -->
  <div class="section" id="bills">
    <div class="card">
      <h2>ğŸ§¾ Nháº­p hÃ³a Ä‘Æ¡n (Ä‘iá»‡n â€“ nÆ°á»›c)</h2>
      <div class="row">
        <label>Chá»n phÃ²ng
          <select id="billRoom"></select>
        </label>
        <label>Tiá»n Ä‘iá»‡n (VND)
          <input id="electricity" type="number" placeholder="VD: 350000"/>
        </label>
        <label>Tiá»n nÆ°á»›c (VND)
          <input id="water" type="number" placeholder="VD: 120000"/>
        </label>
        <label>ThÃ¡ng
          <input id="month" placeholder="VD: 01/2026"/>
        </label>
        <button class="btn primary" onclick="addBill()">â• LÆ°u hÃ³a Ä‘Æ¡n</button>
      </div>
      <div class="muted">Há»‡ thá»‘ng tá»± tÃ­nh <b>Tá»•ng</b> vÃ  <b>Tiá»n / SV</b> theo sá»‘ sinh viÃªn trong phÃ²ng.</div>
    </div>

    <div class="grid two">
      <div class="card">
        <h2>ğŸ“‹ Danh sÃ¡ch hÃ³a Ä‘Æ¡n</h2>
        <div style="height:12px"></div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>PhÃ²ng</th>
                <th>ThÃ¡ng</th>
                <th>Äiá»‡n</th>
                <th>NÆ°á»›c</th>
                <th>Tá»•ng</th>
                <th>Sá»‘ SV</th>
                <th>Tiá»n/SV</th>
                <th>HÃ nh Ä‘á»™ng</th>
              </tr>
            </thead>
            <tbody id="billList"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ§® Chi tiáº¿t chia tiá»n theo tá»«ng sinh viÃªn</h2>
        <div class="row">
          <label>Chá»n hÃ³a Ä‘Æ¡n (PhÃ²ng â€“ ThÃ¡ng)
            <select id="billSelect"></select>
          </label>
          <button class="btn" onclick="viewBillDetail()">ğŸ‘€ Xem chi tiáº¿t</button>
        </div>
        <div style="height:12px"></div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Sinh viÃªn</th>
                <th>Pháº£i Ä‘Ã³ng (VND)</th>
              </tr>
            </thead>
            <tbody id="billDetailList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- DUTY -->
  <div class="section" id="duty">
    <div class="card">
      <h2>ğŸ§¹ Lá»‹ch trá»±c nháº­t (xoay vÃ²ng)</h2>
      <div class="row">
        <label>Chá»n phÃ²ng
          <select id="dutyRoom"></select>
        </label>
        <label>NgÃ y báº¯t Ä‘áº§u
          <input id="startDate" type="date"/>
        </label>
        <button class="btn primary" onclick="generateDuty()">âš™ï¸ Táº¡o lá»‹ch</button>
        <button class="btn danger" onclick="clearDutyForRoom()">ğŸ§½ XÃ³a lá»‹ch phÃ²ng</button>
      </div>
      <div class="muted">CÆ¡ cháº¿: sinh viÃªn trong phÃ²ng Ä‘Æ°á»£c phÃ¢n cÃ´ng láº§n lÆ°á»£t theo tá»«ng ngÃ y.</div>
    </div>

    <div class="card">
      <h2>ğŸ“… Danh sÃ¡ch lá»‹ch trá»±c</h2>
      <div style="height:12px"></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>PhÃ²ng</th>
              <th>Sinh viÃªn</th>
              <th>NgÃ y trá»±c</th>
              <th>Tráº¡ng thÃ¡i</th>
              <th>HÃ nh Ä‘á»™ng</th>
            </tr>
          </thead>
          <tbody id="dutyList"></tbody>
        </table>
      </div>
      <div style="height:10px"></div>
      <span class="badge warn" id="dutyTodayInfo" style="display:none">ğŸ”” CÃ³ ngÆ°á»i trá»±c hÃ´m nay</span>
    </div>
  </div>

  <!-- BOARD -->
  <div class="section" id="board">
    <div class="card">
      <h2>ğŸ“£ Báº£ng tin ná»™i bá»™ (mÆ°á»£n Ä‘á»“ â€“ máº¥t Ä‘á»“ â€“ thÃ´ng bÃ¡o)</h2>
      <div class="row">
        <label>Loáº¡i
          <select id="noticeCategory">
            <option value="MÆ°á»£n Ä‘á»“">MÆ°á»£n Ä‘á»“</option>
            <option value="Máº¥t Ä‘á»“">Máº¥t Ä‘á»“</option>
            <option value="ThÃ´ng bÃ¡o">ThÃ´ng bÃ¡o</option>
            <option value="Nháº¯c trá»±c nháº­t">Nháº¯c trá»±c nháº­t</option>
          </select>
        </label>
        <label>TiÃªu Ä‘á»
          <input id="noticeTitle" placeholder="VD: MÆ°á»£n sáº¡c / Máº¥t vÃ­ á»Ÿ táº§ng 2..."/>
        </label>
      </div>
      <label>Ná»™i dung
        <textarea id="noticeContent" placeholder="MÃ´ táº£ chi tiáº¿t, liÃªn há»‡, thá»i gian..."></textarea>
      </label>
      <div class="row">
        <button class="btn primary" onclick="addNotice()">ğŸ“ ÄÄƒng bÃ i</button>
        <button class="btn" onclick="loadNotices()">ğŸ”„ Táº£i láº¡i</button>
      </div>
         </div>

    <div class="card">
      <h2>ğŸ—‚ï¸ Danh sÃ¡ch bÃ i Ä‘Äƒng</h2>
      <div style="height:12px"></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Loáº¡i</th>
              <th>TiÃªu Ä‘á»</th>
              <th>Ná»™i dung</th>
              <th>Thá»i gian</th>
              <th>HÃ nh Ä‘á»™ng</th>
            </tr>
          </thead>
          <tbody id="noticeList"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <div class="t" id="toastTitle">ThÃ´ng bÃ¡o</div>
  <div class="m" id="toastMsg"></div>
</div>

<script>
/* =========================
   SUPABASE CONFIG
   ========================= */
const SUPABASE_URL = "https://vfrbwfevuzzpqmhwigxp.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_cnsqv6qNt3qClako5aM1ig_Mliz2gFy";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = (id) => document.getElementById(id);

function formatVND(n){
  const x = Number(n || 0);
  return x.toLocaleString("vi-VN");
}

function toast(type, title, msg){
  const t = $("toast");
  t.className = "toast show " + (type || "");
  $("toastTitle").textContent = title || "ThÃ´ng bÃ¡o";
  $("toastMsg").textContent = msg || "";
  setTimeout(()=> t.className = "toast", 2600);
}

function setConn(ok){
  $("connText").textContent = ok ? "OK" : "Lá»—i";
  $("connText").style.color = ok ? "#22c55e" : "#ef4444";
}

/* Theme */
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("ktx_theme", theme);
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme") || "light";
  applyTheme(cur === "dark" ? "light" : "dark");
}
(function initTheme(){
  const saved = localStorage.getItem("ktx_theme") || "light";
  applyTheme(saved);
})();

/* Tabs */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    const name = tab.dataset.tab;
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    $(name).classList.add("active");
  });
});

/* Cache */
let cacheRooms = [];
let cacheStudents = [];
let cacheBills = [];
let cacheDuty = [];
let cacheNotices = [];

/* Connection */
async function checkConnection(){
  try{
    const { error } = await supabaseClient.from("rooms").select("id").limit(1);
    if(error) throw error;
    setConn(true);
  }catch(e){
    setConn(false);
    toast("bad","KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c Supabase", e.message || "Kiá»ƒm tra URL/KEY");
  }
}

/* Dashboard */
function updateDashboard(){
  $("kRooms").textContent = cacheRooms.length;
  $("kStudents").textContent = cacheStudents.length;
  $("kBills").textContent = cacheBills.length;
  $("kDuty").textContent = cacheDuty.length;
  $("kNotices").textContent = cacheNotices.length;

  const today = new Date().toISOString().slice(0,10);
  const hasToday = cacheDuty.some(d => d.duty_date === today);
  $("todayDutyBadge").style.display = hasToday ? "inline-flex" : "none";
}

/* Reload */
async function reloadAll(){
  await Promise.all([
    loadRooms(),
    loadStudents(),
    loadBills(),
    loadDuty(),
    loadNotices()
  ]);
  updateDashboard();
  toast("good","ÄÃ£ táº£i láº¡i","Dá»¯ liá»‡u Ä‘Ã£ cáº­p nháº­t.");
}

/* ROOMS */
function fillRoomSelects(){
  ["roomSelect","billRoom","dutyRoom"].forEach(id=>{
    const sel = $(id);
    if(!sel) return;
    sel.innerHTML = "";
    cacheRooms.forEach(r=>{
      sel.innerHTML += `<option value="${r.id}">${r.room_name}</option>`;
    });
  });
}

async function loadRooms(){
  const { data, error } = await supabaseClient.from("rooms").select("*").order("room_name");
  if(error){ toast("bad","Lá»—i load phÃ²ng", error.message); return; }
  cacheRooms = data || [];

  fillRoomSelects();

  // count students per room
  const countMap = {};
  cacheStudents.forEach(s => countMap[s.room_id] = (countMap[s.room_id]||0) + 1);

  const tbody = $("roomList");
  tbody.innerHTML = "";
  cacheRooms.forEach(r=>{
    const cnt = countMap[r.id] || 0;
    tbody.innerHTML += `
      <tr>
        <td><b>${r.room_name}</b></td>
        <td>${r.max_people ?? ""}</td>
        <td>${cnt}</td>
        <td>
          <button class="btn small danger" onclick="deleteRoom('${r.id}', '${r.room_name.replace(/'/g,"\\'")}')">ğŸ—‘ï¸ XÃ³a</button>
        </td>
      </tr>
    `;
  });
}

async function addRoom(){
  const name = $("roomName").value.trim();
  const max = Number($("maxPeople").value || 0);
  if(!name){ toast("warn","Thiáº¿u tÃªn phÃ²ng","Nháº­p tÃªn phÃ²ng giÃºp mÃ¬nh nha."); return; }

  const { error } = await supabaseClient.from("rooms").insert([{ room_name:name, max_people:max }]);
  if(error){ toast("bad","KhÃ´ng thÃªm Ä‘Æ°á»£c phÃ²ng", error.message); return; }

  $("roomName").value = ""; $("maxPeople").value = "";
  await loadRooms();
  await loadStudents();
  updateDashboard();
  toast("good","ÄÃ£ thÃªm phÃ²ng", `PhÃ²ng ${name} Ä‘Ã£ táº¡o.`);
}

async function deleteRoom(roomId, roomName){
  // block if related data exists
  const { count: cStudents } = await supabaseClient.from("students")
    .select("*",{count:"exact", head:true}).eq("room_id", roomId);
  const { count: cBills } = await supabaseClient.from("bills")
    .select("*",{count:"exact", head:true}).eq("room_id", roomId);
  const { count: cDuty } = await supabaseClient.from("schedules")
    .select("*",{count:"exact", head:true}).eq("room_id", roomId);

  if((cStudents||0) > 0 || (cBills||0) > 0 || (cDuty||0) > 0){
    toast("warn","ChÆ°a thá»ƒ xÃ³a phÃ²ng",
      `PhÃ²ng ${roomName} cÃ²n: SV(${cStudents||0}), hÃ³a Ä‘Æ¡n(${cBills||0}), lá»‹ch trá»±c(${cDuty||0}). XÃ³a liÃªn quan trÆ°á»›c nhÃ©.`);
    return;
  }

  if(!confirm(`XÃ³a phÃ²ng ${roomName}?`)) return;
  const { error } = await supabaseClient.from("rooms").delete().eq("id", roomId);
  if(error){ toast("bad","XÃ³a phÃ²ng tháº¥t báº¡i", error.message); return; }

  await loadRooms();
  updateDashboard();
  toast("good","ÄÃ£ xÃ³a phÃ²ng", `PhÃ²ng ${roomName} Ä‘Ã£ xÃ³a.`);
}

/* STUDENTS */
async function loadStudents(){
  const { data, error } = await supabaseClient
    .from("students")
    .select("id, full_name, room_id, rooms(room_name)")
    .order("full_name");

  if(error){ toast("bad","Lá»—i load sinh viÃªn", error.message); return; }
  cacheStudents = data || [];

  const tbody = $("studentList");
  tbody.innerHTML = "";
  cacheStudents.forEach(s=>{
    tbody.innerHTML += `
      <tr>
        <td>${s.full_name}</td>
        <td>${s.rooms?.room_name || ""}</td>
        <td>
          <button class="btn small danger" onclick="deleteStudent('${s.id}', '${(s.full_name||"").replace(/'/g,"\\'")}')">ğŸ—‘ï¸ XÃ³a</button>
        </td>
      </tr>
    `;
  });

  // refresh rooms table counts if rooms loaded
  if(cacheRooms.length) await loadRooms();
}

async function addStudent(){
  const name = $("studentName").value.trim();
  const roomId = $("roomSelect").value;
  if(!name){ toast("warn","Thiáº¿u há» tÃªn","Nháº­p há» tÃªn sinh viÃªn nhÃ©."); return; }
  if(!roomId){ toast("warn","ChÆ°a cÃ³ phÃ²ng","Táº¡o phÃ²ng trÆ°á»›c nha."); return; }

  const { error } = await supabaseClient.from("students").insert([{ full_name:name, room_id:roomId }]);
  if(error){ toast("bad","KhÃ´ng thÃªm Ä‘Æ°á»£c sinh viÃªn", error.message); return; }

  $("studentName").value = "";
  await loadStudents();
  await loadBills(); // update per-person
  updateDashboard();
  toast("good","ÄÃ£ thÃªm sinh viÃªn", `${name} Ä‘Ã£ thÃªm.`);
}

async function deleteStudent(studentId, name){
  if(!confirm(`XÃ³a sinh viÃªn "${name}"?`)) return;
  const { error } = await supabaseClient.from("students").delete().eq("id", studentId);
  if(error){ toast("bad","XÃ³a sinh viÃªn tháº¥t báº¡i", error.message); return; }

  await loadStudents();
  await loadBills();
  updateDashboard();
  toast("good","ÄÃ£ xÃ³a sinh viÃªn", `${name} Ä‘Ã£ xÃ³a.`);
}

/* BILLS + SPLIT */
async function loadBills(){
  const { data, error } = await supabaseClient
    .from("bills")
    .select("id, room_id, electricity, water, month, rooms(room_name)")
    .order("month", { ascending:false });

  if(error){ toast("bad","Lá»—i load hÃ³a Ä‘Æ¡n", error.message); return; }
  cacheBills = data || [];

  const countMap = {};
  cacheStudents.forEach(s => countMap[s.room_id] = (countMap[s.room_id]||0) + 1);

  const tbody = $("billList");
  tbody.innerHTML = "";

  cacheBills.forEach(b=>{
    const cnt = countMap[b.room_id] || 0;
    const e = Number(b.electricity||0);
    const w = Number(b.water||0);
    const total = e+w;
    const per = cnt>0 ? Math.round(total/cnt) : 0;

    tbody.innerHTML += `
      <tr>
        <td><b>${b.rooms?.room_name||""}</b></td>
        <td>${b.month||""}</td>
        <td>${formatVND(e)}</td>
        <td>${formatVND(w)}</td>
        <td><b>${formatVND(total)}</b></td>
        <td>${cnt}</td>
        <td><b>${formatVND(per)}</b></td>
        <td><button class="btn small danger" onclick="deleteBill('${b.id}')">ğŸ—‘ï¸</button></td>
      </tr>
    `;
  });

  const sel = $("billSelect");
  sel.innerHTML = "";
  cacheBills.forEach(b=>{
    sel.innerHTML += `<option value="${b.id}">${b.rooms?.room_name||""} - ${b.month||""}</option>`;
  });

  if(!cacheBills.length) $("billDetailList").innerHTML = "";
}

async function addBill(){
  const roomId = $("billRoom").value;
  const e = Number($("electricity").value || 0);
  const w = Number($("water").value || 0);
  const m = $("month").value.trim();

  if(!roomId){ toast("warn","ChÆ°a cÃ³ phÃ²ng","Táº¡o phÃ²ng trÆ°á»›c nhÃ©."); return; }
  if(!m){ toast("warn","Thiáº¿u thÃ¡ng","VD: 01/2026"); return; }

  const { error } = await supabaseClient.from("bills").insert([{ room_id:roomId, electricity:e, water:w, month:m }]);
  if(error){ toast("bad","KhÃ´ng thÃªm Ä‘Æ°á»£c hÃ³a Ä‘Æ¡n", error.message); return; }

  $("electricity").value=""; $("water").value=""; $("month").value="";
  await loadBills();
  updateDashboard();
  toast("good","ÄÃ£ lÆ°u hÃ³a Ä‘Æ¡n","OK!");
}

async function deleteBill(id){
  if(!confirm("XÃ³a hÃ³a Ä‘Æ¡n nÃ y?")) return;
  const { error } = await supabaseClient.from("bills").delete().eq("id", id);
  if(error){ toast("bad","XÃ³a hÃ³a Ä‘Æ¡n tháº¥t báº¡i", error.message); return; }
  await loadBills();
  updateDashboard();
  toast("good","ÄÃ£ xÃ³a hÃ³a Ä‘Æ¡n","ÄÃ£ xÃ³a.");
}

async function viewBillDetail(){
  const billId = $("billSelect").value;
  if(!billId){ toast("warn","ChÆ°a cÃ³ hÃ³a Ä‘Æ¡n","HÃ£y thÃªm hÃ³a Ä‘Æ¡n trÆ°á»›c."); return; }

  const { data: bill, error } = await supabaseClient
    .from("bills")
    .select("room_id, electricity, water, month, rooms(room_name)")
    .eq("id", billId).single();

  if(error){ toast("bad","Lá»—i láº¥y hÃ³a Ä‘Æ¡n", error.message); return; }

  const { data: students, error: e2 } = await supabaseClient
    .from("students")
    .select("full_name")
    .eq("room_id", bill.room_id)
    .order("full_name");

  if(e2){ toast("bad","Lá»—i láº¥y sinh viÃªn", e2.message); return; }

  const total = Number(bill.electricity||0) + Number(bill.water||0);
  const per = students.length ? Math.round(total / students.length) : 0;

  const tbody = $("billDetailList");
  tbody.innerHTML = "";
  students.forEach(s=>{
    tbody.innerHTML += `
      <tr>
        <td>${s.full_name}</td>
        <td><b>${formatVND(per)}</b></td>
      </tr>
    `;
  });

  toast("good","Chi tiáº¿t chia tiá»n",
    `PhÃ²ng ${bill.rooms?.room_name||""} (${bill.month||""}) â†’ má»—i SV: ${formatVND(per)} VND`);
}

/* DUTY (schedules: room_id, student_name, duty_date, notified) */
async function loadDuty(){
  const { data, error } = await supabaseClient
    .from("schedules")
    .select("id, student_name, duty_date, room_id, notified, rooms(room_name)")
    .order("duty_date");

  if(error){ toast("bad","Lá»—i load lá»‹ch trá»±c", error.message); return; }
  cacheDuty = data || [];

  const today = new Date().toISOString().slice(0,10);
  const hasToday = cacheDuty.some(d => d.duty_date === today);
  $("dutyTodayInfo").style.display = hasToday ? "inline-flex" : "none";

  const tbody = $("dutyList");
  tbody.innerHTML = "";
  cacheDuty.forEach(d=>{
    const isToday = d.duty_date === today;
    const st = isToday
      ? `<span class="badge warn">ğŸ”” HÃ´m nay</span>`
      : (d.notified ? `<span class="badge ok">âœ… ÄÃ£ nháº¯c</span>` : `<span class="badge">â³ ChÆ°a nháº¯c</span>`);

    tbody.innerHTML += `
      <tr>
        <td><b>${d.rooms?.room_name || ""}</b></td>
        <td>${d.student_name || ""}</td>
        <td>${d.duty_date || ""}</td>
        <td>${st}</td>
        <td>
          <button class="btn small danger" onclick="deleteDuty('${d.id}')">ğŸ—‘ï¸</button>
          ${isToday && !d.notified ? `<button class="btn small primary" onclick="notifyDuty('${d.id}')">ğŸ”” Nháº¯c</button>` : ""}
        </td>
      </tr>
    `;
  });
}

async function generateDuty(){
  const roomId = $("dutyRoom").value;
  const start = $("startDate").value;
  if(!roomId){ toast("warn","ChÆ°a cÃ³ phÃ²ng","Táº¡o phÃ²ng trÆ°á»›c nhÃ©."); return; }
  if(!start){ toast("warn","Thiáº¿u ngÃ y báº¯t Ä‘áº§u","Chá»n ngÃ y báº¯t Ä‘áº§u trá»±c."); return; }

  const { data: students, error } = await supabaseClient
    .from("students")
    .select("full_name")
    .eq("room_id", roomId)
    .order("full_name");

  if(error){ toast("bad","KhÃ´ng láº¥y Ä‘Æ°á»£c SV", error.message); return; }
  if(!students.length){ toast("warn","PhÃ²ng chÆ°a cÃ³ SV","ThÃªm SV rá»“i táº¡o lá»‹ch nha."); return; }

  const startDate = new Date(start);
  const rows = students.map((s, i)=>{
    const d = new Date(startDate);
    d.setDate(startDate.getDate() + i);
    return { room_id: roomId, student_name: s.full_name, duty_date: d.toISOString().slice(0,10), notified:false };
  });

  const { error: e2 } = await supabaseClient.from("schedules").insert(rows);
  if(e2){ toast("bad","Táº¡o lá»‹ch tháº¥t báº¡i", e2.message); return; }

  await loadDuty();
  updateDashboard();
  toast("good","ÄÃ£ táº¡o lá»‹ch trá»±c","OK!");
}

async function clearDutyForRoom(){
  const roomId = $("dutyRoom").value;
  if(!roomId){ toast("warn","ChÆ°a cÃ³ phÃ²ng","Táº¡o phÃ²ng trÆ°á»›c nhÃ©."); return; }
  if(!confirm("XÃ³a toÃ n bá»™ lá»‹ch trá»±c cá»§a phÃ²ng nÃ y?")) return;

  const { error } = await supabaseClient.from("schedules").delete().eq("room_id", roomId);
  if(error){ toast("bad","XÃ³a lá»‹ch tháº¥t báº¡i", error.message); return; }

  await loadDuty();
  updateDashboard();
  toast("good","ÄÃ£ xÃ³a lá»‹ch","OK!");
}

async function deleteDuty(id){
  if(!confirm("XÃ³a lá»‹ch trá»±c nÃ y?")) return;
  const { error } = await supabaseClient.from("schedules").delete().eq("id", id);
  if(error){ toast("bad","XÃ³a tháº¥t báº¡i", error.message); return; }
  await loadDuty();
  updateDashboard();
  toast("good","ÄÃ£ xÃ³a","OK!");
}

async function notifyDuty(dutyId){
  const { data: d, error } = await supabaseClient
    .from("schedules")
    .select("id, student_name, duty_date, rooms(room_name)")
    .eq("id", dutyId).single();

  if(error){ toast("bad","KhÃ´ng nháº¯c Ä‘Æ°á»£c", error.message); return; }

  const title = `Nháº¯c trá»±c nháº­t: ${d.student_name}`;
  const content = `HÃ´m nay (${d.duty_date}) Ä‘áº¿n lÆ°á»£t ${d.student_name} trá»±c phÃ²ng ${d.rooms?.room_name || ""}.`;

  const { error: e2 } = await supabaseClient.from("notices").insert([{
    category: "Nháº¯c trá»±c nháº­t",
    title, content
  }]);
  if(e2){ toast("bad","KhÃ´ng táº¡o Ä‘Æ°á»£c thÃ´ng bÃ¡o", e2.message); return; }

  const { error: e3 } = await supabaseClient.from("schedules").update({ notified:true }).eq("id", dutyId);
  if(e3){ toast("warn","ÄÃ£ táº¡o thÃ´ng bÃ¡o nhÆ°ng chÆ°a Ä‘Ã¡nh dáº¥u", e3.message); }

  await loadDuty();
  await loadNotices();
  updateDashboard();
  toast("good","ÄÃ£ nháº¯c trá»±c","ThÃ´ng bÃ¡o Ä‘Ã£ lÃªn báº£ng tin.");
}

/* NOTICES (notices: category, title, content, created_at) */
async function loadNotices(){
  const { data, error } = await supabaseClient
    .from("notices")
    .select("id, category, title, content, created_at")
    .order("created_at", { ascending:false });

  if(error){ toast("bad","Lá»—i load báº£ng tin", error.message); return; }
  cacheNotices = data || [];

  const tbody = $("noticeList");
  tbody.innerHTML = "";
  cacheNotices.forEach(n=>{
    const time = n.created_at ? new Date(n.created_at).toLocaleString("vi-VN") : "";
    const cat = n.category || "ThÃ´ng bÃ¡o";
    const badgeCls = cat.includes("Máº¥t") ? "warn" : (cat.includes("MÆ°á»£n") ? "pink" : "ok");

    tbody.innerHTML += `
      <tr>
        <td><span class="badge ${badgeCls}">${cat}</span></td>
        <td><b>${n.title || ""}</b></td>
        <td style="max-width:420px">${n.content || ""}</td>
        <td>${time}</td>
        <td><button class="btn small danger" onclick="deleteNotice('${n.id}')">ğŸ—‘ï¸</button></td>
      </tr>
    `;
  });
}

async function addNotice(){
  const category = $("noticeCategory").value;
  const title = $("noticeTitle").value.trim();
  const content = $("noticeContent").value.trim();

  if(!title || !content){
    toast("warn","Thiáº¿u thÃ´ng tin","Nháº­p tiÃªu Ä‘á» + ná»™i dung nhÃ©.");
    return;
  }

  const { error } = await supabaseClient.from("notices").insert([{ category, title, content }]);
  if(error){ toast("bad","KhÃ´ng Ä‘Äƒng Ä‘Æ°á»£c", error.message); return; }

  $("noticeTitle").value=""; $("noticeContent").value="";
  await loadNotices();
  updateDashboard();
  toast("good","ÄÃ£ Ä‘Äƒng bÃ i","OK!");
}

async function deleteNotice(id){
  if(!confirm("XÃ³a bÃ i Ä‘Äƒng nÃ y?")) return;
  const { error } = await supabaseClient.from("notices").delete().eq("id", id);
  if(error){ toast("bad","XÃ³a bÃ i tháº¥t báº¡i", error.message); return; }
  await loadNotices();
  updateDashboard();
  toast("good","ÄÃ£ xÃ³a bÃ i","OK!");
}

/* INIT */
(async function init(){
  await checkConnection();

  // load order matters (students needed for bill split counts)
  await loadRooms();
  await loadStudents();
  await loadBills();
  await loadDuty();
  await loadNotices();

  // set default start date
  const today = new Date().toISOString().slice(0,10);
  $("startDate").value = today;

  updateDashboard();
})();
</script>

</body>
</html>
